<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>掌控内核 - ebpf整体概念和入门 - SGSG&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="SGSG&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="SGSG&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这篇其实算是ebpf0x0"><meta property="og:type" content="blog"><meta property="og:title" content="掌控内核 - ebpf整体概念和入门"><meta property="og:url" content="https://sgsgsama.github.io/ctf/ebpf/ebpf0x1/"><meta property="og:site_name" content="SGSG&#039;s Blog"><meta property="og:description" content="这篇其实算是ebpf0x0"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://sgsgsama.github.io/img/og_image.png"><meta property="article:published_time" content="2025-05-18T14:20:04.000Z"><meta property="article:modified_time" content="2025-07-16T03:52:50.926Z"><meta property="article:author" content="SGSG"><meta property="article:tag" content="Andorid"><meta property="article:tag" content="ebpf"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://sgsgsama.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://sgsgsama.github.io/ctf/ebpf/ebpf0x1/"},"headline":"掌控内核 - ebpf整体概念和入门","image":["https://sgsgsama.github.io/img/og_image.png"],"datePublished":"2025-05-18T14:20:04.000Z","dateModified":"2025-07-16T03:52:50.926Z","author":{"@type":"Person","name":"SGSG"},"publisher":{"@type":"Organization","name":"SGSG's Blog","logo":{"@type":"ImageObject","url":"https://sgsgsama.github.io/img/logo.svg"}},"description":"这篇其实算是ebpf0x0"}</script><link rel="canonical" href="https://sgsgsama.github.io/ctf/ebpf/ebpf0x1/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="SGSG&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Github" href="https://github.com/SGSGsama"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-05-18T14:20:04.000Z" title="2025/5/18 22:20:04">2025-05-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-16T03:52:50.926Z" title="2025/7/16 11:52:50">2025-07-16</time></span><span class="level-item"><a class="link-muted" href="/categories/ebpf/">ebpf</a></span><span class="level-item">17 minutes read (About 2476 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">掌控内核 - ebpf整体概念和入门</h1><div class="content"><p>这篇其实算是ebpf0x0</p>
<span id="more"></span>
<h2 id="什么是ebpf"><a href="#什么是ebpf" class="headerlink" title="什么是ebpf"></a>什么是ebpf</h2><p>ebpf由bpf演变而来，其最初的作用是数据链路层的报文过滤框架，之后随着bpf的功能不断拓展有了ebpf框架，除了报文过滤外还添加了追踪&#x2F;拦截系统调用的功能<br>根据docs.ebpf.io中的介绍，ebpf主要有以下几个核心内容</p>
<h3 id="Programs"><a href="#Programs" class="headerlink" title="Programs"></a>Programs</h3><p>ebpf程序，ebpf本质上是一个c语言编写，llvm（通常来说是这样）编译的.o二进制文件，使用linux的loader library(libbpf)动态加载到内核中，从而实现用户态和内核态的交互以及监视内核行为<br>与通常的c语言程序不同，为了确保内核安全，loader会对程序做检查，禁用循环等可能产生危险的行为（你也不想你内核里有个程序卡死吧）</p>
<h3 id="Helper-functions"><a href="#Helper-functions" class="headerlink" title="Helper functions"></a>Helper functions</h3><p>一些内置的函数，用于在ebpf程序中执行一些高级操作</p>
<h3 id="KFuncs"><a href="#KFuncs" class="headerlink" title="KFuncs"></a>KFuncs</h3><p>作用和Helper functions相同，都是提供一些高级操作，因为Helper functions属于UAPI，为了稳定性考虑Helper functions实际上是不更新的，所以KFuncs负责拓展功能，但与之相对的KFuncs在不同linux版本之间不保证api兼容性</p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>分为array_map和hash_map(任意键值对)，实际上就是ebpf中管理内存的方式（malloc是危险的），但是Maps提供的功能远比管理内存强大，Maps是内核共享的，所以能实现bpf程序之间，bpf程序和用户态程序之间的数据交互</p>
<h3 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h3><p>ebpf程序和maps都是对象，由ebpf loader创建，并且每个对象都会获得一个fd作为它的唯一标识符，对象的生命周期采用一种智能的管理方法，会在所有指向其的引用消失后自动回收，fd是内核共享的，用户态程序可以通过这些fd共享ebpf程序的信息，fd还可以通过pining储存在bpf file system中，pining的对象会由bpf file system维持其引用，也就是不会被回收</p>
<h2 id="使用环境"><a href="#使用环境" class="headerlink" title="使用环境"></a>使用环境</h2><p>ebpf作为一个比较新的框架功能迭代非常快，如果条件允许可以尽量使用新的内核版本，一般来说建议使用5.10以上的版本，然后发行版镜像一般不会开启完整的ebpf功能，如果有条件可以自行编译内核开启完整功能（比如syscall 和 ftrace），不过依靠kprobe已经能实现不少功能,这个系列文章基于的设备是内核序列号为<a target="_blank" rel="noopener" href="https://dl.google.com/dl/android/aosp/oriole-bp2a.250605.031.a2-factory-747402f2.zip?hl=zh-cn">oriole-bp2a.250605.031.a2</a>的pixel 6，使用官方出厂镜像，只使用<a target="_blank" rel="noopener" href="https://kernelsu.org/zh_CN/guide/installation.html">KernelSU</a>添加了root，无其他修改</p>
<p>考虑到bcc本身搭建环境比较复杂，而且在编写内核态程序时使用的是类c的语法，所以本文章不使用bcc，而是采用在linux虚拟机（桌面平台）中交叉编译后直接push可执行文件到手机的方案，采用的加载器是libbpf，这样所有编码都采用c&#x2F;c++实现（我不会写go所以用不了cilium）</p>
<h2 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h2><p>关于交叉编译，如果想简单体验的话可以直接用这个项目开始<a target="_blank" rel="noopener" href="https://github.com/JiaHuann/libbpf-bootstrap-android">libbpf-bootstrap-android</a>,这是libbpf-bootstrap的安卓迁移版本，修改了makefile配置使其支持交叉编译，同时也准备了zlib.a和libelf.a两个静态链接库，除了要自己下载ndk工具链外基本不需要准备任何依赖</p>
<p>如果想研究自行交叉编译，可以参考下面的脚本，这应该是ebpf最简单的交叉编译方法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">aarch64-linux-android35-clang \  <span class="comment"># 使用ndk-clang编译内核态.o文件</span></span><br><span class="line">    -I./libbpf_include \  <span class="comment"># 给编译器添加libbpf相关的头文件搜索路径</span></span><br><span class="line">    -I./zlib_include \  <span class="comment"># 添加zlib相关头文件搜索路径</span></span><br><span class="line">    -I./libelf_include \  <span class="comment"># 添加libelf相关头文件搜索路径</span></span><br><span class="line">    -I/home/sgsg/android-ndk-r27c/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/aarch64-linux-android \  <span class="comment"># 添加arm64 linux c头文件搜索路径，不然的话编译器会去/usr下找x86的头文件，然后编译就挂了</span></span><br><span class="line">    -g -O2 -Wall -target bpf -D__TARGET_ARCH_aarch64 \  <span class="comment"># 指定目标格式为bpf，指定架构为arm64</span></span><br><span class="line">    -c bpf_test.bpf.c \  <span class="comment"># 添加源代码文件</span></span><br><span class="line">    -o bpf_test.bpf.o -static <span class="comment"># 静态链接，避免依赖问题</span></span><br><span class="line"></span><br><span class="line">bpftool gen skeleton bpf_test.bpf.o &gt; bpf_test.skel.h  <span class="comment"># libbpf建议使用skeleton加载，具体就是在内核态elf生成完毕后，使用bpftool生成.h文件，这个.h文件里包含了内核态文件完整的字节码和对应的加载函数，直接在用户态中引入这个头文件调用预生成的函数就可以加载程序到内核了</span></span><br><span class="line"></span><br><span class="line">aarch64-linux-gnu-gcc test_bpf_loader.c \  <span class="comment"># 添加源代码文件</span></span><br><span class="line">    -I./libbpf_include \  <span class="comment"># 同样添加头文件路径</span></span><br><span class="line">    -I./zlib_include \ </span><br><span class="line">    -I./libelf_include \</span><br><span class="line">    -I/home/sgsg/android-ndk-r27c/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/aarch64-linux-android \</span><br><span class="line">    ./libs/libbpf.a \  <span class="comment"># 静态链接依赖</span></span><br><span class="line">    ./libs/libz.a \</span><br><span class="line">    ./libs/libelf.a \</span><br><span class="line">    -o loader -static <span class="comment"># 静态编译，可以省去很多跨平台兼容性问题，就是产物会稍微大一点</span></span><br></pre></td></tr></table></figure>
<p>项目文件结构如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">── bpf_test<span class="selector-class">.bpf</span><span class="selector-class">.c</span></span><br><span class="line">├── bpf_test<span class="selector-class">.bpf</span><span class="selector-class">.o</span></span><br><span class="line">├── bpf_test<span class="selector-class">.skel</span><span class="selector-class">.h</span></span><br><span class="line">├── build<span class="selector-class">.sh</span></span><br><span class="line">├── libbpf_include</span><br><span class="line">│   └── bpf</span><br><span class="line">│       ├── bpf_core_read<span class="selector-class">.h</span></span><br><span class="line">│       ├── bpf_endian<span class="selector-class">.h</span></span><br><span class="line">│       ├── bpf<span class="selector-class">.h</span></span><br><span class="line">│       ├── bpf_helper_defs<span class="selector-class">.h</span></span><br><span class="line">│       ├── bpf_helpers<span class="selector-class">.h</span></span><br><span class="line">│       ├── bpf_tracing<span class="selector-class">.h</span></span><br><span class="line">│       ├── btf<span class="selector-class">.h</span></span><br><span class="line">│       ├── hashmap<span class="selector-class">.h</span></span><br><span class="line">│       ├── libbpf_common<span class="selector-class">.h</span></span><br><span class="line">│       ├── libbpf<span class="selector-class">.h</span></span><br><span class="line">│       ├── libbpf_internal<span class="selector-class">.h</span></span><br><span class="line">│       ├── libbpf_legacy<span class="selector-class">.h</span></span><br><span class="line">│       ├── libbpf_version<span class="selector-class">.h</span></span><br><span class="line">│       ├── relo_core<span class="selector-class">.h</span></span><br><span class="line">│       ├── skel_internal<span class="selector-class">.h</span></span><br><span class="line">│       └── usdt<span class="selector-class">.bpf</span><span class="selector-class">.h</span></span><br><span class="line">├── libelf_include</span><br><span class="line">│   ├── elf-knowledge<span class="selector-class">.h</span></span><br><span class="line">│   ├── gelf<span class="selector-class">.h</span></span><br><span class="line">│   ├── libelf<span class="selector-class">.h</span></span><br><span class="line">│   ├── nlist<span class="selector-class">.h</span></span><br><span class="line">│   └── version<span class="selector-class">.h</span></span><br><span class="line">├── libs</span><br><span class="line">│   ├── libbpf<span class="selector-class">.a</span></span><br><span class="line">│   ├── libelf<span class="selector-class">.a</span></span><br><span class="line">│   └── libz<span class="selector-class">.a</span></span><br><span class="line">├── test_bpf_loader<span class="selector-class">.c</span></span><br><span class="line">├── vmlinux<span class="selector-class">.h</span></span><br><span class="line">└── zlib_include</span><br><span class="line">    ├── blast<span class="selector-class">.h</span></span><br><span class="line">    ├── crc32<span class="selector-class">.h</span></span><br><span class="line">    ├── crypt<span class="selector-class">.h</span></span><br><span class="line">    ├── deflate<span class="selector-class">.h</span></span><br><span class="line">    ├── gzguts<span class="selector-class">.h</span></span><br><span class="line">    ├── gzlog<span class="selector-class">.h</span></span><br><span class="line">    ├── infback9<span class="selector-class">.h</span></span><br><span class="line">    ├── inffast<span class="selector-class">.h</span></span><br><span class="line">    ├── inffix9<span class="selector-class">.h</span></span><br><span class="line">    ├── inffixed<span class="selector-class">.h</span></span><br><span class="line">    ├── inflate9<span class="selector-class">.h</span></span><br><span class="line">    ├── inflate<span class="selector-class">.h</span></span><br><span class="line">    ├── inftree9<span class="selector-class">.h</span></span><br><span class="line">    ├── inftrees<span class="selector-class">.h</span></span><br><span class="line">    ├── ioapi<span class="selector-class">.h</span></span><br><span class="line">    ├── iowin32<span class="selector-class">.h</span></span><br><span class="line">    ├── mztools<span class="selector-class">.h</span></span><br><span class="line">    ├── puff<span class="selector-class">.h</span></span><br><span class="line">    ├── trees<span class="selector-class">.h</span></span><br><span class="line">    ├── unzip<span class="selector-class">.h</span></span><br><span class="line">    ├── zconf<span class="selector-class">.h</span></span><br><span class="line">    ├── zconf<span class="selector-class">.h</span><span class="selector-class">.cmakein</span></span><br><span class="line">    ├── zconf<span class="selector-class">.h</span><span class="selector-class">.in</span></span><br><span class="line">    ├── zfstream<span class="selector-class">.h</span></span><br><span class="line">    ├── zip<span class="selector-class">.h</span></span><br><span class="line">    ├── zlib<span class="selector-class">.h</span></span><br><span class="line">    ├── zlib_how<span class="selector-class">.html</span></span><br><span class="line">    ├── zstream<span class="selector-class">.h</span></span><br><span class="line">    └── zutil.h</span><br></pre></td></tr></table></figure>
<p>其中这些依赖和头文件可以去<a target="_blank" rel="noopener" href="https://github.com/JiaHuann/libbpf-bootstrap-android">libbpf-bootstrap-android</a>中获取，libbpf.a需要运行一次make后在example&#x2F;c&#x2F;libbpf中获取，vmlinux.h需要使用<a target="_blank" rel="noopener" href="https://github.com/libbpf/bpftool/releases">bpftool</a>在手机上运行<code>bpftool btf dump file /sys/kernel/btf/vmlinux format c</code>，如果你的手机没有该文件说明不支持bpf头文件（稍微新一点的基本都支持），那就要使用libbpf-bootstrap-android中提供的头文件<br>想要查看手机支持ebpf的哪些特性可以通过运行<code>bpftool feature</code>查看</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bpf_test.bpf.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;kprobe/kernel_clone&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog</span><span class="params">(<span class="type">void</span> *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    bpf_printk(<span class="string">&quot;Hello from eBPF with Skeleton!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bpf_test_loader.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bpf_test.skel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_test_bpf</span> *<span class="title">skel</span>;</span></span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    skel = bpf_test_bpf__open_and_load();</span><br><span class="line">    bpf_test_bpf__attach(skel);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;BPF skeleton loaded and attached successfully. Press enter to exit...\n&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    bpf_test_bpf__destroy(skel);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个简单的demo，用来跟踪clone命令内置的kprobe挂载点，只要clone命令触发（任何创建新进程的行为都需要调用clone）就会在sys&#x2F;kernel&#x2F;tracing&#x2F;trace_pipe这个文件（比较新的内核都是这个路径，老一点的是在debug路径下的，如果没有的话手动挂载一下tracingFS和debugFS）中输出<code>Hello from eBPF with Skeleton!</code><br>在使用前需要在&#x2F;sys&#x2F;kernel&#x2F;tracing&#x2F;tracing_on中输入1开启跟踪<code>echo 1 &gt; tracing_on</code><br>然后运行loader程序就可以看跟踪结果了</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">130</span>|oriole:<span class="symbol">/sys/kernel/tracing</span> <span class="comment"># echo 1 &gt; tracing_on</span></span><br><span class="line">oriole:<span class="symbol">/sys/kernel/tracing</span> <span class="comment"># cat trace_pipe</span></span><br><span class="line">  Lite Thread <span class="comment">#2-10604   [003] d..3 36892.084632: bpf_trace_printk: Hello from eBPF with Skeleton!</span></span><br><span class="line">  Lite Thread <span class="comment">#1-10088   [005] d..3 36892.087729: bpf_trace_printk: Hello from eBPF with Skeleton!</span></span><br><span class="line">    lowpool[<span class="number">756</span>]-<span class="number">1210</span>    [<span class="number">000</span>] d..<span class="number">3</span> <span class="number">36892.151596</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36892.805585</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line"> roid.apps.turbo-<span class="number">6207</span>    [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36892.929320</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">    BG Thread <span class="comment">#0-6234    [000] d..3 36892.942382: bpf_trace_printk: Hello from eBPF with Skeleton!</span></span><br><span class="line">    BG Thread <span class="comment">#0-6234    [000] d..3 36892.944007: bpf_trace_printk: Hello from eBPF with Skeleton!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">001</span>] d..<span class="number">3</span> <span class="number">36893.813645</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">001</span>] d..<span class="number">3</span> <span class="number">36894.820207</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">002</span>] d..<span class="number">3</span> <span class="number">36895.824630</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">002</span>] d..<span class="number">3</span> <span class="number">36896.828603</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">   POSIX timer <span class="number">3</span><span class="operator">-</span><span class="number">2540</span>    [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36897.530348</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36897.832404</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">   POSIX timer <span class="number">3</span><span class="operator">-</span><span class="number">2540</span>    [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36898.688762</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">002</span>] d..<span class="number">3</span> <span class="number">36898.840582</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">002</span>] d..<span class="number">3</span> <span class="number">36899.845768</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">   POSIX timer <span class="number">3</span><span class="operator">-</span><span class="number">2540</span>    [<span class="number">000</span>] d..<span class="number">3</span> <span class="number">36900.606367</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">000</span>] d..<span class="number">3</span> <span class="number">36900.850164</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">002</span>] d..<span class="number">3</span> <span class="number">36901.857614</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">   POSIX timer <span class="number">3</span><span class="operator">-</span><span class="number">2540</span>    [<span class="number">001</span>] d..<span class="number">3</span> <span class="number">36902.128525</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">001</span>] d..<span class="number">3</span> <span class="number">36902.862111</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">001</span>] d..<span class="number">3</span> <span class="number">36903.866426</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36904.872046</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">  servicemanager-<span class="number">480</span>     [<span class="number">003</span>] d..<span class="number">3</span> <span class="number">36905.876475</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">   POSIX timer <span class="number">3</span><span class="operator">-</span><span class="number">2540</span>    [<span class="number">000</span>] d..<span class="number">3</span> <span class="number">36906.276747</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br><span class="line">        kthreadd-<span class="number">2</span>       [<span class="number">004</span>] d..<span class="number">3</span> <span class="number">36906.461608</span>: <span class="params">bpf_trace_printk:</span> Hello from eBPF <span class="keyword">with</span> Skeleton<span class="operator">!</span></span><br></pre></td></tr></table></figure>
<p>可以看到系统服务创建新进程的行为都被捕捉到了</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>掌控内核 - ebpf整体概念和入门</p><p><a href="https://sgsgsama.github.io/ctf/ebpf/ebpf0x1/">https://sgsgsama.github.io/ctf/ebpf/ebpf0x1/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SGSG</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-05-18</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-16</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Andorid/">Andorid</a><a class="link-muted mr-2" rel="tag" href="/tags/ebpf/">ebpf</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=67bd96aba47a1e001adc61bf&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/ctf/%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/BASE64/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">BASE64</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/development/compose_beginer/"><span class="level-item">compose 组件速查</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="SGSG"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">SGSG</p><p class="is-size-6 is-block">逆向魔法使</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Utopia</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives/"><p class="title">38</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories/"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags/"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/SGSGsama" target="_blank" rel="me noopener">Follow</a></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Andorid/"><span class="tag">Andorid</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XCTF/"><span class="tag">XCTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/codeforces/"><span class="tag">codeforces</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ebpf/"><span class="tag">ebpf</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/frida/"><span class="tag">frida</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/go/"><span class="tag">go</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/js/"><span class="tag">js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reverse/"><span class="tag">reverse</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/selenium/"><span class="tag">selenium</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web-re/"><span class="tag">web-re</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8A%A0%E5%AF%86-%E7%BC%96%E7%A0%81/"><span class="tag">加密&amp;编码</span><span class="tag">8</span></a></div></div></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-29T06:31:51.000Z">2025-07-29</time></p><p class="title"><a href="/development/go/go0x4/">Effective go</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-29T02:14:26.000Z">2025-07-29</time></p><p class="title"><a href="/development/go/go0x3/">tour of go day3</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-28T02:28:39.000Z">2025-07-28</time></p><p class="title"><a href="/development/go/go0x2/">tour of go day2</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-24T02:33:53.000Z">2025-07-24</time></p><p class="title"><a href="/development/go/go0x1/">tour of go day1</a></p><p class="categories"><a href="/categories/Development/">Development</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-16T06:38:55.000Z">2025-07-16</time></p><p class="title"><a href="/ctf/ebpf/ebpf0x3/">连接用户与内核 -  ebpf之ringBuffer与全局变量</a></p><p class="categories"><a href="/categories/ebpf/">ebpf</a></p></div></article></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#什么是ebpf"><span class="level-left"><span class="level-item">1</span><span class="level-item">什么是ebpf</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Programs"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Programs</span></span></a></li><li><a class="level is-mobile" href="#Helper-functions"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Helper functions</span></span></a></li><li><a class="level is-mobile" href="#KFuncs"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">KFuncs</span></span></a></li><li><a class="level is-mobile" href="#Maps"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">Maps</span></span></a></li><li><a class="level is-mobile" href="#Objects"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">Objects</span></span></a></li></ul></li><li><a class="level is-mobile" href="#使用环境"><span class="level-left"><span class="level-item">2</span><span class="level-item">使用环境</span></span></a></li><li><a class="level is-mobile" href="#交叉编译"><span class="level-left"><span class="level-item">3</span><span class="level-item">交叉编译</span></span></a></li><li><a class="level is-mobile" href="#demo"><span class="level-left"><span class="level-item">4</span><span class="level-item">demo</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="SGSG&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 SGSG</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>